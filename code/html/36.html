

	<!DOCTYPE html>
	<meta charset="utf-8">
	<head>

	<style>

	.link {
	  stroke: #999;
	}

	</style>


<!--	<script type="text/javascript" src="../scripts/d3.js"></script>-->
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="../scripts/jquery.min.js"></script>

	</head>

	<body>
		<div id="viz"></div>
		<div align="center">
			<button id="save_data"> Save the graph </button>
		</div>
		<script type="text/javascript">

	//Binding data to elements using the key function instead of the regular index. successful :) 


			var width = 1270;
			var height = 600;
			var color = d3.scale.category20();

//			var nodes = [{label:"e",group:1},{label:"e",group:2,},];	//just some two nodes to start with
//			var links = [{"source":0, "target":1}];	//just an edge to start with

			var nodes=[], links=[];
			var count = 0; //to know whether the mouse click was on the source node or on the target node while creating edges.
			var source, target; //source and target nodes while creating edges using mouse clicks.

			var force = d3.layout.force()
					.size([width,height])
					.charge(-60)
					.linkDistance(30);

			var svg = d3.select("#viz")
				.append("svg")
				.attr("width",width)
				.attr("height", height)
				.style("border", "2px solid black")

//loading initial graph from json file. This graph can later be modified through the GUI.
			d3.json("../json/6.json", function(error, graph)
			{

				force.nodes(graph.nodes)
				.links(graph.links)
				.start()
				.on("tick", tick);
	
				svg.on("mousedown", svg_mousedown);

			   var node = svg.selectAll(".node");
			   var link = svg.selectAll(".link");

			nodes = force.nodes(),
			    links = force.links();

			
			function key(datum)
			{
				return datum.key;
			}


//add a node by clicking anywhere on the svg canvas
			function svg_mousedown()
			{
				var point = d3.mouse(this);
				var keys_array = [];
				for (var i=0; i<nodes.length; i++)
				{
					keys_array.splice(i,0,parseInt(nodes[i].key));
				}
				var new_key = d3.max(keys_array) + 1;
				console.log(new_key);

				var node_item = {key:new_key,x:point[0],y:point[1],label:"e",group:Math.round(Math.random()*10)};
				nodes.push(node_item);
				restart();
			}

//when a source node and target node is clicked, a link is added between them.

			function node_mousedown(d,i) 
			{

				if(count == 1)	//clicked on target
				{
					target = i;
					if (source !== target){
						var keys_array = [];
						for (var i=0; i<links.length; i++)
						{
							keys_array.splice(i,0,parseInt(links[i].key));
						}
						var new_key = d3.max(keys_array) + 1;

						console.log(new_key);
						links.push({key:new_key, "source":source, "target":target});
						count = 0;
						restart();
					}
				}
				else if (count == 0)	//clicked on source
				{
					source = i;
					count = 1;
				}

			}
				

			function tick() {
				link.attr("x1", function(d) { return d.source.x; })
				    .attr("y1", function(d) { return d.source.y; })
				    .attr("x2", function(d) { return d.target.x; })
				    .attr("y2", function(d) { return d.target.y; });

				node.attr("cx", function(d) { return d.x; })
				    .attr("cy", function(d) { return d.y; });
			}

			function restart()
			{

				link = link.data(links, key);

				link.enter().insert("line",".node")
				.attr("class", "link");

				node = node.data(nodes, key);

				node.enter().append("circle")
				.attr("class", "node")
				.attr("r", 5)
				.attr("fill", function(d){ return color(d.group);})
				.on("mousedown", node_mousedown)
				.call(force.drag);


				force.start();

			}


			restart();

			});

			$(document).ready(function(){
				$("#save_data").click(function(){
				nodes_copy = [];	//I will copy only some attributes of nodes into this.
				links_copy = [];
				for (var i=0; i<nodes.length; i++)
				{
					nodes_copy[i] = {};
					nodes_copy[i].key = nodes[i].key;
					nodes_copy[i].label = nodes[i].label;
					nodes_copy[i].name = nodes[i].name;
					nodes_copy[i].group = nodes[i].group;
				}
				
				for(var i=0; i<links.length; i++)
				{

					links_copy[i] = {};
					links_copy[i].key = links[i].key;
					links_copy[i].source = links[i].source.index;
					links_copy[i].target = links[i].target.index;
				}
			

					nodes_string = JSON.stringify(nodes_copy);					
					links_string = JSON.stringify(links_copy);
					console.log(nodes_string);
					console.log(links_string);
					
					$.ajax({
						type: "POST",
						url: "../php/6.php",
						//data: "name=John&location=Boston&count="+count
						data: {nodes:nodes_string, links: links_string}
						}).done( function(msg){
							alert( "Data Saved: \n" + msg );
							}).fail( function( xmlHttpRequest, statusText, errorThrown ) {
								alert(
									"Your form submission failed.\n\n"
									+ "XML Http Request: " + JSON.stringify( xmlHttpRequest )
									+ ",\nStatus Text: " + statusText
									+ ",\nError Thrown: " + errorThrown );
								});
				});


			});

	</script>


