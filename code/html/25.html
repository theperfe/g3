<!--This is Sebastian's modified version of the code that I sent him - 21.html -->

<!DOCTYPE html>
<html>
<body>  
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<div id="viz"></div>
		<script type="text/javascript">

			var width = 900;
			var height = 500;
			var fill = d3.scale.category20();

			var nodes = [{},{}];	//just some two nodes to start with
			var links = [{"source":0, "target":1}];	//just an edge to start with

			var count = 0; //to know whether the mouse click was on the source node or on the target node while creating edges.
			var source, target; //source and target nodes while creating edges using mouse clicks.

			// Force Layout
			var force = d3.layout.force()
					.size([width,height])
					.nodes(nodes)
					.links(links)
					.linkDistance(30)
					.charge(-60)
					.on("tick", tick)
					.start(); // Added this to get the Force Layout to start when it is created - that way we don't have to call restart right away

			// SVG Container + Mouse Event (mousedown)
			var svg = d3.select("body")
				  .append("svg")
				  .attr("width",width)
				  .attr("height", height)
				  .style("border", "2px solid black")
				  .on("mousedown", svg_mousedown);

		 // This causes a problem since this code attaches an event listener to each each
		 // element in the current selection.  The first time we run this selection, there are no elements to attach our listener to.
		 // We have to add listeners to the initial Force Layout as well as everytime we add in a node.
	   //var node = svg.selectAll(".node").on("mousedown", node_mousedown);
		 //var link = svg.selectAll(".link");

		 // Create the initial LINK Selection - Add the initial edge between the two initial nodes
		 var link = svg.selectAll(".link")
		     .data(force.links())
		   .enter().append("line")
		     .attr("class", "link")
		     .style("stroke", "#ccc");

		 // Create the initial NODE Selection - Add the initial two nodes and add mouse listener events to them
      var node = svg.selectAll(".node")
          .data(force.nodes())
        .enter().append("circle")
          .attr("class", function (d,i) { return "node" + i; })
          .attr("r", 7)
					.on("mousedown", function() {  d3.event.stopPropagation(); })
          .on("mousedown", node_mousedown)
          .call(force.drag);

		/**
		 * Function Definitions Below Which Are Used Above:
		 * tick()
		 * svg_mousedown()
		 * node_mousedown(d,i)
		 * restart()
		 */

			// tick() - Runs the force layout one step
			function tick() {
				link.attr("x1", function(d) { return d.source.x; })
				    .attr("y1", function(d) { return d.source.y; })
				    .attr("x2", function(d) { return d.target.x; })
				    .attr("y2", function(d) { return d.target.y; });

				node.attr("cx", function(d) { return d.x; })
				    .attr("cy", function(d) { return d.y; });
			}


			// svg_mousedown() - Adds a node based on a user click to the SVG Force Layout, then restarts the Force Layout
			function svg_mousedown()
			{
				var point = d3.mouse(this);
				var newNode = {x:point[0],y:point[1]};
				
				nodes.push(newNode);

				restart();
			}


			// node_mousedown(d, i) - Figures out which node we clicked and whether it's the first or second node, then creates a new link object
			function node_mousedown(d, i)
			{

				// We get the index of the node in the node array.  This is then used for the links.
				nodeIndex = i

				// If the count === 0, then we are clicking on our first node and want to set this as the source index
				if (count === 0) {
					sourceIndex = nodeIndex;
					count = 1;
				} 

				// Else If the count === 1, then we are clicking on the second node and want to set this as the target index
				else if (count === 1) {
					targetIndex = nodeIndex
					links.push({"source":sourceIndex, "target":targetIndex});
					count = 0;					
				}

				// We then restart the force layout
				restart();

			}
				


			// restart() - Restarts adds new data to links and nodes, then selects the enter() selection, then restarts the Force Layout
			function restart()
			{
				
				// Bind Data to Link and Node Selections 
				link = link.data(links);
				node = node.data(nodes);

				// Add Links
				link.enter()
				  .append("line")
				    .attr("class", "link")
				    .style("stroke", "#ccc"); // Added stroke to see the link
				
				// Add Node
				node
				  .enter().append("circle")
						.attr("class", function (d,i) { return "node" + i; })
				    .attr("r", 7)
						.on("mousedown", function() {  d3.event.stopPropagation(); })
	          .on("mousedown", node_mousedown)
				    .call(force.drag);  // Make sure to add listeners to each node that we have added

				// Restart Force Layout
				force.start();

			}

	</script>
</body>
</html>
